<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Machine Room â€“ DB Overview</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cc-ui.css') }}" />
    <style>
      body { background: var(--bg); color: var(--text); }
      .topbar { display: flex; justify-content: space-between; align-items: center; padding: var(--pad); background: var(--surface); border-bottom: 1px solid var(--line); }
      .card { background: var(--elev); border: 1px solid var(--line); border-radius: var(--radius); padding: var(--pad); box-shadow: var(--shadow); margin-bottom: var(--pad); }
      .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--pad); }
      .overview-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: var(--pad); }
      table { width: 100%; border-collapse: collapse; }
      th, td { padding: 0.6rem 0.4rem; border-bottom: 1px solid var(--line); text-align: left; }
      th { color: var(--muted); font-weight: 600; }
      .metric-number { font-size: 2rem; font-weight: 700; margin: 0.3rem 0 0; }
      .metric h2 { margin: 0; }
      .db-uri code { background: #0c1118; padding: 0.35rem 0.45rem; border-radius: 10px; border: 1px solid var(--line); display: inline-block; }
      .cc-main { max-width: 1100px; margin: 0 auto; padding: var(--pad); }
      .link-small { color: var(--accent); text-decoration: none; }
      .link-small:hover, .link-small:focus { text-decoration: underline; }
      .section-label { color: var(--muted); font-size: 0.9rem; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 0.3rem; display: block; }
      .muted { color: var(--muted); }
    </style>
  </head>
  <body class="cc-body">
    <header class="topbar">
      <div class="brand">Machine Room</div>
      <a href="{{ url_for('home') }}" class="link-small">Back to dashboard</a>
    </header>

    <main class="cc-main">
      <section class="card">
        <h1>System Overview &amp; Audit</h1>
        {% if not project_summary %}
          <p class="muted">Project summary not available; check TheBrain/project_summary.json.</p>
        {% else %}
          {% set project = project_summary.get('project', {}) %}
          {% set primary_flows = project_summary.get('primary_user_flows', []) %}
          {% set stack = project_summary.get('stack', {}) %}
          {% set work_orders = project_summary.get('work_orders', {}) %}

          <div class="overview-grid">
            <div>
              <span class="section-label">Project</span>
              <h2 style="margin: 0">{{ project.get('name', 'Unknown Project') }}</h2>
              <p style="margin: 0.2rem 0 0.4rem;">Status: <strong>{{ project.get('status', 'Unknown') }}</strong></p>
              <p>{{ project.get('purpose', 'No purpose documented.') }}</p>
              {% if project.get('notes') %}
              <p class="muted" style="margin: 0.2rem 0 0;">{{ project.get('notes') }}</p>
              {% endif %}
            </div>

            <div>
              <span class="section-label">Primary Flows</span>
              {% if primary_flows %}
              <ul>
                {% for flow in primary_flows %}
                <li>{{ flow }}</li>
                {% endfor %}
              </ul>
              {% else %}
              <p class="muted">No flows documented.</p>
              {% endif %}
            </div>

            <div>
              <span class="section-label">Stack</span>
              {% set backend = stack.get('backend', {}) %}
              <p style="margin: 0 0 0.4rem;">
                {{ backend.get('framework', 'Unknown framework') }} on {{ backend.get('language', 'Unknown language') }}<br />
                Database: {{ backend.get('database', 'Not documented') }}
              </p>
              {% if backend.get('services') %}
                <ul>
                  {% for svc in backend.get('services', []) %}
                    <li>{{ svc }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>

            <div>
              <span class="section-label">Work Orders</span>
              {% set completed = work_orders.get('completed_or_legacy', []) %}
              {% set planned = work_orders.get('planned_next', []) %}
              <p style="margin: 0 0 0.2rem;"><strong>Completed/Legacy:</strong></p>
              {% if completed %}
                <ul>
                  {% for item in completed %}
                    <li>{{ item }}</li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="muted">No completed items recorded.</p>
              {% endif %}
              <p style="margin: 0 0 0.2rem;"><strong>Planned Next:</strong></p>
              {% if planned %}
                <ul>
                  {% for item in planned %}
                    <li>{{ item }}</li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="muted">No upcoming work noted.</p>
              {% endif %}
            </div>
          </div>
        {% endif %}
      </section>

      <section class="card">
        <h1>Database Status</h1>
        <p>Backend: <strong>{{ db_type }}</strong></p>
        <p class="db-uri">
          Connection URI:
          <code>
            {{ db_uri.split('@')[-1] if 'postgres' in db_uri else db_uri }}
          </code>
        </p>

        <div class="metrics-grid">
          <div class="metric">
            <h2>Employees</h2>
            <p class="metric-number">{{ employee_count }}</p>
          </div>
          <div class="metric">
            <h2>Flights</h2>
            <p class="metric-number">{{ flight_count }}</p>
          </div>
          <div class="metric">
            <h2>Maintenance</h2>
            <p class="metric-number">{{ maintenance_count }}</p>
          </div>
          <div class="metric">
            <h2>Audit Log</h2>
            <p class="metric-number">{{ audit_count }}</p>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Recent Employees</h2>
        <table>
          <thead>
            <tr><th>Name</th><th>Role</th><th>Shift</th><th>Base</th></tr>
          </thead>
          <tbody>
            {% for emp in recent_employees %}
            <tr>
              <td>{{ emp.name }}</td>
              <td>{{ emp.role }}</td>
              <td>{{ emp.shift }}</td>
              <td>{{ emp.base or "-" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>

      <section class="card">
        <h2>Recent Flights</h2>
        <table>
          <thead>
            <tr><th>Flight</th><th>Date</th><th>ETA</th><th>Origin</th><th>Destination</th></tr>
          </thead>
          <tbody>
            {% for f in recent_flights %}
            <tr>
              <td>{{ f.flight_number }}</td>
              <td>{{ f.date }}</td>
              <td>{{ f.eta_local or '-' }}</td>
              <td>{{ f.origin or '-' }}</td>
              <td>{{ f.destination or '-' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>

      <section class="card">
        <h2>Maintenance Items</h2>
        <table>
          <thead>
            <tr><th>Item</th><th>Due Date</th><th>Status</th><th>Priority</th></tr>
          </thead>
          <tbody>
            {% for item in recent_maintenance %}
            <tr>
              <td>{{ item.item_name }}</td>
              <td>{{ item.due_date or '-' }}</td>
              <td>{{ item.status }}</td>
              <td>{{ item.priority or '-' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>

      <section class="card">
        <h2>Recent Changes (Audit Log)</h2>
        <table>
          <thead>
            <tr>
              <th>When</th>
              <th>Entity</th>
              <th>Action</th>
              <th>Actor</th>
              <th>Actor Role</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in recent_audit %}
            <tr>
              <td>{{ entry.timestamp }}</td>
              <td>{{ entry.entity_type }} #{{ entry.entity_id or "?" }}</td>
              <td>{{ entry.action }}</td>
              <td>{{ entry.actor_name or "-" }}</td>
              <td>{{ entry.actor_role or "-" }}</td>
              <td>{{ entry.description or "-" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>
    </main>
  </body>
</html>
