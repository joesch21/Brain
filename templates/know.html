{% extends "_layout.html" %}
{% block title %}Know â€” CodeCrafter{% endblock %}
{% block content %}
<h1 class="cc-h1">Know</h1>
<form id="know-form" method="post" class="cc-form" action="/know">
  <label for="question-input">Question</label>
  <div style="display:flex; gap:0.5rem; align-items:flex-start;">
    <input
      id="question-input"
      type="text"
      name="question"
      class="cc-input"
      placeholder="Ask something about the projectâ€¦"
      required
      style="flex:1;"
      value="{{ prefill_question or '' }}"
    />
    <button
      type="button"
      class="cc-btn"
      id="know-voice-button"
      title="Speak your question"
      aria-label="Speak your question"
    >
      ğŸ¤
    </button>
    <button id="ask-btn" class="cc-btn cc-btn--primary" type="submit">Ask</button>
  </div>
  <div id="know-voice-transcript" class="voice-transcript">
    <!-- Voice transcript will appear here -->
  </div>
  <p class="voice-hint" style="margin-top:0.5rem; color:#9fbad2;">
    Tip: Tap the mic in the top bar and say â€œask Know about todayâ€™s flightsâ€.
  </p>
</form>

<div class="cc-card" style="margin-top:1.5rem;">
  <h2>Answer</h2>
  <div id="answer-body" class="cc-body">(answer appears here)</div>
  <h3>Sources</h3>
  <ul id="answer-sources"></ul>
</div>

<script>
const form = document.getElementById('know-form');
const questionInput = document.getElementById('question-input');

form.addEventListener('submit', async (event)=>{
  event.preventDefault();
  const fd = new FormData(form);
  const r = await fetch('/api/know', { method:'POST', body:fd });
  const j = await r.json();
  document.getElementById('answer-body').textContent = j.answer;
  document.getElementById('answer-sources').innerHTML = j.sources.map(s=>`<li>${s}</li>`).join('');
  if (j.answer) voice.speak(j.answer);
});

const urlParams = new URLSearchParams(window.location.search);
const presetQuestion = questionInput.value || urlParams.get('voice_q') || urlParams.get('q');
if (presetQuestion) {
  questionInput.value = presetQuestion;
  form.dispatchEvent(new Event('submit', { cancelable: true }));
}

const knowVoiceBtn = document.getElementById("know-voice-button");
if (knowVoiceBtn) {
  knowVoiceBtn.addEventListener("click", () => {
    if (window.voice) {
      window.voice.startListening();
    }
  });
}
</script>
{% endblock %}
