{% extends "_layout.html" %}
{% block title %}Know â€” CodeCrafter{% endblock %}
{% block content %}
<h1 class="cc-h1">Know</h1>
<form id="know-form" method="post" class="cc-form" action="/know">
  <label for="know-question-input">Question</label>
  <div style="display:flex; gap:0.5rem; align-items:flex-start;">
    <input id="know-question-input" name="question" type="text" class="cc-input" placeholder="Ask something about the projectâ€¦" required style="flex:1;" value="{{ prefill_question or '' }}" />
    <button type="button" class="cc-btn" aria-label="Speak question" onclick="window.voice.startDictation()">ğŸ¤</button>
    <button id="ask-btn" class="cc-btn cc-btn--primary" type="submit">Ask</button>
  </div>
  <p class="voice-hint" style="margin-top:0.5rem; color:#9fbad2;">
    Tip: Tap the mic in the top bar and say â€œask Know about todayâ€™s flightsâ€.
  </p>
</form>

<div class="cc-card" style="margin-top:1.5rem;">
  <h2>Answer</h2>
  <div id="answer-body" class="cc-body">(answer appears here)</div>
  <h3>Sources</h3>
  <ul id="answer-sources"></ul>
</div>

<script>
const form = document.getElementById('know-form');
const questionInput = document.getElementById('know-question-input');

form.addEventListener('submit', async (event)=>{
  event.preventDefault();
  const fd = new FormData(form);
  const r = await fetch('/api/know', { method:'POST', body:fd });
  const j = await r.json();
  document.getElementById('answer-body').textContent = j.answer;
  document.getElementById('answer-sources').innerHTML = j.sources.map(s=>`<li>${s}</li>`).join('');
  if (j.answer) voice.speak(j.answer);
});

const urlParams = new URLSearchParams(window.location.search);
const presetQuestion = questionInput.value || urlParams.get('voice_q') || urlParams.get('q');
if (presetQuestion) {
  questionInput.value = presetQuestion;
  form.dispatchEvent(new Event('submit', { cancelable: true }));
}
</script>
{% endblock %}
